## **Linux Bride**

**Mục lục**

**1. Tổng quan giới thiệu về Linux Brigde**

**1.1. Giới thiệu**

- **Linux bridge** là một soft switch -1 trong 3 công nghệ cung cấp switch ảo trong hệ thống linux (bên cạnh macvlan và openswitch), giải 

quyết vấn đề ảo hóa network bên trong máy chủ vật lý.

- Bản chất, linux bridge sẽ tạo ra các switch layer 2 kết nối các máy ảo (VM) để các VM đó giao tiếp lại với nhau và có thể kết nối được ra

bên ngoài. Linux bride thường được sử dụng kết hợp với hệ thống ảo hóa KVM-QEMU.

- Linux Bride thực chất chính là switch ảo được sử dụng với ảo hóa KVM/QEMU. Đó là một module trong nhân kernel. Sử dụng câu lệnh `brctl` để 

quản lý.

- Mô tả linux brigde (trường hợp cơ bản nhất)

 [![](https://github.com/iamjohnny95/repolis_internship/raw/master/img/KVM/10.png)](https://github.com/iamjohnny95/repolis_internship/blob/master/img/KVM/10.png)

 **Lưu ý:** Linux Bridge được dùng kết hợp với card ethernet của máy host. Không sử dụng với card wireless.

 **1.2 Cấu trúc hệ thống sử dụng Linux Bridge**

 [![](https://github.com/iamjohnny95/repolis_internship/raw/master/img/KVM/11.png)](https://github.com/iamjohnny95/repolis_internship/blob/master/img/KVM/11.png)

 Khái niệm về physical port và virtual port:

 - **Virtual Computing Device:** Thường được biết đến như là các máy ảo VM chạy trong host server 

 - **Virtual NIC (vNIC)**: máy ảo VM có Virtual net virtual. Cả work adapters (vNIC) mà đóng vai  virtual switch. Cả trò là NIC cho máy ảo

 - **Physical switch port:** là port sử dụng cho ethernet switch, cổng vật lý xác định bởi các port RJ45. Một port RJ45 kết nối tới port 

 trên NIC của máy host.

 - Virtual switch port: là port ảo tồn tại trên virtual switch. Cả virtual NIC (vNIC) và virtual port đều là phần mềm, nó liên kết với 

 virtual cable kết nối vNIC. 

 **2. Tìm hiểu Linux Bridge** 

 **2.1. Cấu trúc và các thành phần**

 Cấu trúc Linux Bridge

[![](https://github.com/iamjohnny95/repolis_internship/raw/master/img/KVM/12.png)](https://github.com/iamjohnny95/repolis_internship/blob/master/img/KVM/12.png)

Một số khái niệm liên quan tới linux bridge:

- **Port**: Tương đương với port của switch thật 

- **Brigde**: Tương đương với switch layer 2 

- **Tap**: Hay tap interface có thể hiểu là giao diện mạng để các VM kết nối với bridge cho linux bridge tạo ra(nó nằm trong nhân kernel, 

hoạt động ở lớp 2 của mô hình OSI)

-**fd**: forward data - chuyển tiếp dữ liệu từ máy ảo tới bridge

**2.2: Các tính năng**

- **STP**: Spanning Tree Protocol - giao thức chống loop gói tin trong mạng.

- **VLAN**: Chia switch (do linux bridge tạo ra) thành các mạng LAN ảo, cô lập traffic giữa các VM trên các VLAN khác nhau của cùng một 

switch.

- **FDB**: Chuyển tiếp các gói tin theo database để nâng cao hiệu suất switch.

**3.Các thao tác quản lý Linux Bridge**

**3.1 Cài đặt công cụ phần mềm quản lý Linux Bridge**

Linux Bridge được hỗ trợ từ version nhân kernel từ 2.4 trở lên. Để sử dụng và quản lý các tính năng của linux bridge, cần cài đặt gói bridge 

-utilities (dùng các câu lệnh `brctl` để sử dụng linux bridge) Cài đặt dùng lệnh như sau:

`yum install bridge-ultils -y`

**3.2. Một số câu lệnh để quản lý**

**BRIDGE MANAGEMENT**

|**ACTION**|**BRCTL**|**BRIDGE**|
|--|--|--|
|creating bridge|brctl addbr <bridge>||
|deleting bridge|brctl delbr <bridge>||
|add interface (port) to bridge|brctl addif <bridge> <ifname>||
|delete interface (port) on bridge|brctl delbr <bridge>||

**FDB MANAGEMENT**

|**ACTION**|**BRCTL**|**BRIDGE**|
|--|--|--|
|Shows a list of MACs in FDB|brctl showmacs <bridge>|bridge fdb show|
|Sets FDB entries ageing time|brctl setageingtime <bridge> <time>||
|Sets FDB garbage collector interval|brctl setgcint <brname> <time> ||
|Adds FDB entry||bridge fdb add dev <interface> [dst, vni, port, via]|
|Appends FDB entry||bridge fdb append (parameters same as for fdb add)|
|Deletes FDB entry||bridge fdb delete (parameters same as for fdb add)|

**STP MANAGEMENT**

|**ACTION**|**BRCTL**|**BRIDGE**|
|--|--|--|
|Turning STP on/off|brctl stp <bridge> <state>||
|Setting bridge priority|brctl setbridgeprio <bridge> <priority>||
|Setting bridge forward delay|brctl setfd <bridge> <time>||
|Setting bridge 'hello' time|brctl sethello <bridge> <time>	||
|Setting bridge maximum message age|brctl setmaxage <bridge> <time>||
|Setting cost of the port on bridge|brctl setpathcost <bridge> <port> <cost>|bridge link set dev <port> cost <cost>|
|Setting bridge port priority|brctl setportprio <bridge> <port> <priority>|bridge link set dev <port> priority <priority>|
|Should port proccess STP BDPUs||bridge link set dev <port > guard [on, off]|
|Should bridge might send traffic on the port it was received||bridge link set dev <port> hairpin [on,off]|
|Enabling/disabling fastleave options on port||bridge link set dev <port> fastleave [on,off]|
|Setting STP port state||bridge link set dev <port> state <state>|

**VLAN MANAGEMENT**

|**ACTION**|**BRCTL**|**BRIDGE**|
|--|--|--|
|Creating new VLAN filter entry||bridge vlan add dev <dev> [vid, pvid, untagged, self, master]|
|Delete VLAN filter entry||bridge vlan delete dev <dev> (parameters same as for vlan add)|
|List VLAN configuration||bridge vlan show|

**Lưu ý** Các ảnh hưởng của câu lệnh chỉ là tạm thời cho đến khi máy host khởi động lại, sau khi khởi động lại, toàn bộ thông tin sẽ bị mất. 

**4. Ghi chép về một số khái niệm liên quan**

**4.1. Port**

- Trong networking, khái niệm port đại diện cho điểm vào ra của dữ liệu trên máy tính hoặc thiết bị mạng máy tính hoặc các thiết bị mạng. 

Port có thể là khái niệm phần mềm hoặc phần cứng. Software port là khái niệm tồn tại trong hệ điều hành. Chúng thường là các điểm vào ra 

cho các lưu lượng ứng dung. Tức là khái niệm port ở mức logic. Ví dụ: Port 80 trên server liên kết với web server và truyền các lưu lượng 

HTTP.

- Hardware port (port khái niệm phần cứng): là các điểm kết nối lưu lượng ở mức khái niệm vật lý trên các thiết bị mạng như switch, máy tính

router... Ví dụ: route với kết nối RJ45 (L2/Ethernet) kết nối tới máy tính của bạn.

- Physical switch port: Thông thường chúng ta hay sử dụng các switch L2/ethernet với các cổng RJ45. Một đầu connector RJ45 kết nối port trên

switch tới các port trên NIC của máy tính.

- Virtual switch port: giống như các physical port mà tồn tại như một phần mềm trên switch ảo. cả virtual NIC và virtual port đều duy trì 

bởi phần mềm trên switch ảo. Cả virtual NIC và virtual Port đều duy trì bởi phần mềm, được kết nối với nhau thông qua virtual cable.

**4.2** UPlink port

- Uplink port là khái niệm chỉ điểm vào ra của lưu lượng trong một switch ra các mạng bên ngoài. Nó sẽ là nơi tập trung tất cả các lưu lượng

trên switch nếu muốn ra mạng ngoài. 


[![](https://github.com/iamjohnny95/repolis_internship/raw/master/img/KVM/13.png)](https://github.com/iamjohnny95/repolis_internship/blob/master/img/KVM/13.png)

- Khái niệm virtual uplink switch port được hiểu có chức năng tương đương, là ưu điểm để các lưu lượng trên các máy guest ảo đi ra ngoài máy

host thật, hoặc đi ra ngoài mạng. Khi thêm một interface trên máy thật và bridge (tạo mạng bridge )


